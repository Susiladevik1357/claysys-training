<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Event Planner</title>
<style>
  :root{
    --accent: #4CAF50;
    --admin-accent: #6c63ff;
    --bg: #f5f5f7;
    --card: #fff;
    --muted: #666;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: Inter, Arial, sans-serif;
    background:var(--bg);
    height:100vh;
    display:flex;
    align-items:flex-start;
    justify-content:center;
    padding:20px;
  }

  /* Container */
  .app {
    width:1100px;
    max-width:1100%;
    background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.95));
    box-shadow:0 8px 30px rgba(0,0,0,0.08);
    border-radius:12px;
    height:fit-content;
    display:grid;
    grid-template-columns: 300px 1fr;
  }

  /* LEFT: Auth or Sidebar */
  .left {
    background:var(--accent);
    color:#fff;
    padding:20px;
    display:flex;
    flex-direction:column;
    gap:30px;

    align-items:stretch;
  }
 

  .brand {font-weight:700;font-size:1.1rem; display:flex; align-items:center; gap:10px}
  .brand .logo {font-size:1.6rem}
  .auth-card {
    background: rgba(255,255,255,0.06);
    padding:14px;
    border-radius:8px;
  }
  label{font-size:0.9rem;color:rgba(255,255,255,0.95);display:block;margin-top:8px}
  input, select, textarea {
    width:100%;
    padding:8px 10px;
    margin-top:6px;
    border-radius:6px;
    border: none;
    outline: none;
    font-size:0.95rem;
  }
  .btn {
    background:#fff;color:var(--accent);border:none;padding:10px;border-radius:8px;cursor:pointer;margin-top:12px;font-weight:600;
  }
  .btn.alt { background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.2); }

  /* RIGHT: Main app */
  .right {
    padding:18px;
    display:flex;
    flex-direction:column;
    gap:12px;
  }

  .topbar {
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }
  .topbar h1 {

    font-size:1.2rem;
    margin:0;
    color:var(--muted)
  }
  .topbar .actions {
    display:flex;
    align-items:center;
    gap:8px
  }

  /* Sections */
  .section { 
    display:none;
    flex: 1;
    overflow-y: auto;
    
  
  }
  .section.active { 
    display:block; 
  }

  /* Tiles and cards */
  .tiles { display:grid;
    grid-template-columns: repeat(2,1fr);
    gap:14px;
    margin:12px 0;
  }
  .tile {
    background:var(--card); 
    padding:14px; 
    border-radius:10px; 
    box-shadow:0 1px 6px rgba(0,0,0,0.06); 
  }
  .tile h3 { 
    margin:0 0 8px 0; 
    font-size:0.95rem; 
    color:#333 
  }
  .tile p { margin:0; 
    color:var(--muted); font-size:0.85rem }

  .list { 
    display:flex; 
    flex-direction:column; 
    gap:10px; 
  }

  .card { 
    background:var(--card); 
    padding:12px; 
    border-radius:8px; 
    box-shadow:0 1px 6px rgba(0,0,0,0.04); 
    border-color: #333;
    
  }
  .card table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed; /* ensures equal column widths */
  overflow-x: auto;
  display: block; /* allows horizontal scrolling if needed */
}

.card th, .card td {
  padding: 8px;
  text-align: left;
  border-bottom: 1px solid #ddd;
  word-wrap: break-word; /* prevents text from overflowing */
}

  .card h3 { 
    margin:0 0 8px 0; 
    font-size:0.95rem 
    
  }
  .muted { 
    color:var(--muted); 
    font-size:0.9rem 
  }

  /* Table */

  /* Modal */
  .modal {
    
    inset:0; 
    display:none; 
    align-items:center; 
    justify-content:center;
    background:rgba(0,0,0,0.4); z-index:30;
  }
  .modal.show { 
    display:flex; 
  }
  .modal .panel { 
    width:94%; max-width:520px; 
    background:#fff; padding:16px; 
    border-radius:10px; 
  }

  /* small buttons */
  .small { 
    padding:6px 8px; 
    border-radius:6px; 
    border:none; 
    cursor:pointer; 
    font-weight:600 
  }
  .green { 
    background:var(--accent); 
    color:#fff 
  }
  .purple { 
    background:var(--admin-accent); 
    color:#fff 
  }
  .danger { 
    background:#f44336; 
    color:#fff 
  }
  .blue { 
    background:#2196F3; 
    color:#fff 
  }
  /* CARD STYLING */
.card {
  background: #f7f6f6; /* White background */
  padding: 16px;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  margin-bottom: 20px; /* spacing between cards */
}

/* CARD HEADER SPACING */
.card h2, .card h3 {
  margin-top: 0;
  margin-bottom: 12px; /* space below headers */
}

/* SECTION SPACING */
.section {
  margin-top: 20px;
  margin-bottom: 20px;
}

/* EVENT CARDS */
#eventsList .card {
  background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
}

/* GUEST MANAGEMENT CARD */
#user-guests .card {
  background: #f9f9f9;
}

/* AGENDA CARD */
#user-agenda .card {
  background: #fcfcfc;
}

/* NO ACCESS CARD */
#no-access .card {
  background: #ffe6e6;
}


/* STATUS TAGS */
.status {
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 0.8rem;
  font-weight: 600;
}

.st-planning { background: #2196F3; color: #fff; }
.st-ongoing { background: #FF9800; color: #fff; }
.st-completed { background: #4CAF50; color: #fff; }

/* TABLE STYLING */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 12px;
}

th, td {
  padding: 10px;
  border-bottom: 1px solid #eee;
}

/* INPUT / SELECT SPACING */
input, select, textarea, button {
  margin-bottom: 8px;
}

/* MODAL PANEL SPACING */
/* ---------- Center the Add Event Modal ---------- */
#modalEvent {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: none; /* hidden by default */
  justify-content: center;
  align-items: center;
  background: rgba(0,0,0,0.5); /* dim background */
  z-index: 9999;
}

#modalEvent.show {
  display: flex; /* show modal and center it */
}

/* Style the inner panel */
#modalEvent .panel {
  background: #fff;
  padding: 25px;
  border-radius: 12px;
  width: 90%;
  max-width: 400px;
  box-shadow: 0 5px 20px rgba(0,0,0,0.3);
  animation: popIn 0.3s ease;
}

@keyframes popIn {
  from { transform: scale(0.9); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

.modal .panel {
  background: #fff;
  padding: 20px;
  border-radius: 10px;
}

.modal .panel h3 {
  margin-top: 0;
  margin-bottom: 12px;
}
#admin-categories .card {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

#admin-categories .card input {
  flex: 1;
  min-width: 200px;
}

#admin-categories .card button {
  align-self: center;
}

#categoryTable td {
  text-align: center; /* center horizontally */
  vertical-align: middle; /* center vertically */
}

#categoryTable td button {
  margin: auto; /* center buttons */
}
.category-add {
  display: flex;
  justify-content: flex-start;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

.category-add input {
  flex: 1;
  min-width: 150px;
}

.category-add button {
  white-space: nowrap;
}
/* Sidebar scroll for overflow */
#sidebar {
  overflow-y: auto;
  max-height: 100vh; /* Prevent overflow off screen */
}

/* Logout button styling */
.logout-btn {
  display: flex;
  align-items: center;
  justify-content: center; /* CENTER text + icon */
  gap: 6px;
  font-weight: 600;
  padding: 8px;
  width: 100%;
  text-align: center; /* optional but ensures centering */
  box-sizing: border-box;
}

.logout-btn i {
  font-size: 1rem;
}

/* Ensure all sidebar buttons show icons consistently */
.btn.alt {
  display: flex;
  align-items: center;
  gap: 6px;
}

/* MOBILE LAYOUT FIXS */
@media (max-width: 768px) {
.login-title {
  display: none;
}
  .app {
    display: flex;
    flex-direction: column; /* Stack sidebar and main content */
    width: 100%;
    height: auto;
  }
  .left {
    width: 100%;
    padding: 10px;
  }
  .right {
    width: 100%;
    padding: 10px;

    
  }
}


/* Make tables scroll horizontally on mobile */
@media (max-width: 480px) {
  .login-title {
  display: none;
}
  table {
    display: block;
    overflow-x: auto;
    white-space: nowrap;
  }
  thead {
    display: none; /* hide table header */
  }
  tr {
    display: block;
    margin-bottom: 12px;
    border-bottom: 1px solid #ddd;
  }
  td {
    display: flex;
    justify-content: space-between;
    padding: 8px;
    border-bottom: 1px solid #eee;
    white-space: normal;
  }
  td::before {
    content: attr(data-label);
    font-weight: bold;
    flex: 1;
    .logout-btn {
    font-size: 0.95rem;
    padding: 8px;
  }
}
}


/* Responsive tiles/cards */
.tiles {
  grid-template-columns: 1fr; /* Stack on mobile */
}

/* Make modals fit mobile screen */
.modal .panel {
  width: 95%;
  max-width: 100%;
  padding: 16px;
  box-sizing: border-box;
}

.login-title {
  position: absolute;
  top: 50%;
  left: 50%;
  margin-top:-100px;
  font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
  margin-left: 100px;
  transform: translate(-50%, -50%);
  font-size: 2.5rem; /* increase font size */
  font-weight: bold;
  color: rgb(54, 137, 12); /* or any color you want */
  text-align: center;
}

  /* tiny helpers */
  .right h2 { margin:0; font-size:1.05rem }
  .row { display:flex; gap:8px; align-items:center }
  .spacer { flex:1 }
  .center { text-align:center }
  .status { font-size:0.78rem; padding:6px 8px; border-radius:6px; color:#fff }
  .st-planning { background:#2196F3 }
  .st-ongoing { background:#FF9800 }
  .st-completed { background:var(--accent) }
  .linklike { background:none;border:none;color:var(--accent);cursor:pointer;font-weight:600 }
</style>
</head>
<body>

<div class="app">

  <!-- LEFT: Login/Register area OR sidebar when logged in -->
  <div class="left" id="left-pane">

    <div class="brand">
      <div class="logo">ðŸ“…</div>
      <div>
        <div style="font-size:0.9rem"><h1>Event Planner</h1></div>
      </div>
    </div>

    <!-- AUTH: login/register simplified (no credential required) -->
    <div id="auth-area" class="auth-card">
      <div id="auth-forms">
        <div id="login-form">
          <label>Enter your name</label>
          <input id="loginUser" placeholder="username" />
          <label>Choose role</label>
          <select id="loginRole">
            <option value="User">User</option>
            <option value="Admin">Admin</option>
          </select>
          <div style="margin-top:10px;display:flex;gap:8px">
            <button class="btn" onclick="loginNoCredential()">Continue</button>
            <button class="btn alt" onclick="clearLocal()">Reset Data</button>
          </div>
         
        </div>
      </div>
    </div>

    <!-- Sidebar when logged in -->
    <div id="sidebar" style="display:none">
      <div class="card" style="background:transparent;box-shadow:none;padding:6px 0;color:rgba(255,255,255,0.95)">
        <div id="welcomeText">Welcome</div>
      </div>

      <div class="card" style="background:rgba(255,255,255,0.06);color:#fff">
        <div style="font-size:0.95rem;font-weight:700">Navigation</div>
        <div style="margin-top:8px;display:flex;flex-direction:column;gap:20px">
          <!-- Admin nav -->
          <button class="btn alt nav-admin" id="nav-dashboard" onclick="showAdminSection('dashboard')">Admin Dashboard</button>
          <button class="btn alt nav-admin" id="nav-users" onclick="showAdminSection('users')">User Management</button>
          <button class="btn alt nav-admin" id="nav-categories" onclick="showAdminSection('categories')">Categories</button>
          <button class="btn alt nav-admin" id="nav-backups" onclick="showAdminSection('backups')">Backups</button>

          <!-- User nav -->
          <button class="btn alt nav-user" id="nav-user-events" onclick="showUserSection('events')">Events</button>
          <button class="btn alt nav-user" id="nav-user-guests" onclick="showUserSection('guests')">Guests</button>
          <button class="btn alt nav-user" id="nav-user-agenda" onclick="showUserSection('agenda')">Agenda</button>

          <button class="btn alt logout-btn" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Logout
          </button>

        </div>
      </div>

    </div>

  </div>

  <!-- RIGHT: Main content area -->
  <div class="right">
    
    <div class="topbar">
       <h1 id="pageTitle"></h1>
     
    
      <div class="actions">
        <div id="roleLabel" class="muted"></div>
      </div>
      </div>
    

    <!-- ADMIN: dashboard -->
    <div id="admin-dashboard" class="section">
      <h2>Admin Dashboard</h2>
      <div class="tiles">
        <div class="tile">
          <h3>Users</h3>
          <p id="adminUserCount">0</p>
        </div>
        <div class="tile">
          <h3>Categories</h3>
          <p id="adminCategoryCount">0</p>
        </div>
        <div class="tile">
          <h3>Events</h3>
          <p id="adminEventCount">0</p>
        </div>
        <div class="tile">
          <h3>Backups</h3>
          <p id="adminBackupCount">0</p>
        </div>
      </div>
      <div class="list">
        <div class="card">
          <h3>Quick Actions</h3>
          <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
            <button class="small purple" onclick="openCreateAdmin()">Create Admin</button>
            <button class="small" onclick="downloadData()">Export Data</button>
            <button class="small" onclick="clearAllData()">Clear All Data</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ADMIN: user mgmt -->
    <div id="admin-users" class="section">
      <h2>Users</h2>
      <div class="card">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <input id="filterUsers" placeholder="Search users..." onkeyup="renderAdminUsers()" />
          <select id="filterRole" onchange="renderAdminUsers()">
            <option value="">All Roles</option>
            <option>Admin</option>
            <option>User</option>
          </select>
        </div>
      </div>
      <h2>User List</h2><br>

      <div class="card">
        <table id="usersTable">
  <thead>
    <tr>
      <th>Username</th>
      <th>Email</th>
      <th>Role</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

      </div>
    </div>

    <!-- ADMIN: categories -->
    <!-- ADMIN: categories -->
<div id="admin-categories" class="section">
  <h2>Categories</h2>

  <!-- Add Category Section -->
  <div class="card category-add">
    <label for="newCategory">Add Category</label>
    <div class="category-add-controls">
      <input id="newCategory" placeholder="Category name" />
      <button class="small" onclick="addCategory()">Add Category</button>
    </div>
  </div>
  <h2>categories List</h2><br>
  <!-- Categories Table -->
  <div class="card">
    <table id="categoryTable">
      <thead>
        <tr>
          <th>Category</th>
          <th style="text-align:center;">Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>
    <!-- ADMIN: backups -->
    <div id="admin-backups" class="section">
      <h2>Backup & Restore</h2>
      <div class="card">
        <button class="small" onclick="createBackup()">Create Backup</button>
        <button class="small" onclick="restoreLastBackup()">Restore Last</button>
        <button class="small" onclick="showAllBackups()">Show Backups</button>
      </div>
      <div class="card">
        <ul id="backupList"></ul>
      </div>
    </div>

    <!-- USER: events -->
    <div id="user-events" class="section">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>Events</h2>
        <div>
          <button class="small" onclick="openEventModal()">+ Add Event</button>
        </div>
      </div>

      <div class="card">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <input id="searchEvent" placeholder="Search events..." oninput="renderEvents()" />
          <select id="filterEventStatus" onchange="renderEvents()"><br>
            <option value="">All Status</option>
            <option value="Planning">Planning</option>
            <option value="Ongoing">Ongoing</option>
            <option value="Completed">Completed</option>
          </select>
        </div>
      </div>
      <h2>Event List</h2>

      <div id="eventsList" style="display:grid;gap:10px;margin-top:10px"></div>

    </div>
    <!-- USER: guests -->
    <div id="user-guests" class="section">
      <h2>Guest Management</h2>
      <div class="card">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <input id="guestName" placeholder="Guest name" />
          <input id="guestEmail" placeholder="Guest email" />
          <select id="guestEventSelect"><option value="">Select event</option></select>
          <button class="small" onclick="addOrUpdateGuest()">Add Guest</button>
          <button class="small" onclick="sendInvitations()">Send Invitations</button>
        </div>
      </div>

      <div class="card">
        <table>
          <table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Email</th>
      <th>Event</th>
      <th>RSVP</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="guestTable">
    <!-- Example Row -->
    <tr>
      <td data-label="Name">John Doe</td>
      <td data-label="Email">john@example.com</td>
      <td data-label="Event">Birthday Party</td>
      <td data-label="RSVP">Yes</td>
      <td data-label="Actions">
        <button class="small green">Edit</button>
        <button class="small danger">Delete</button>
      </td>
    </tr>
    
  </tbody>
</table>

      </div>
    </div>

    <!-- USER: agenda -->
    <div id="user-agenda" class="section">
      <h2>Agenda</h2>
      <div class="card">
        <label>Choose event</label>
        <select id="agendaEventSelect" onchange="renderAgendaForEvent()"><option value="">Select event</option></select>
      </div>
      <div id="agendaList" style="margin-top:10px;display:grid;gap:8px"></div>
    </div>

    <!-- Generic: No-access -->
    <div id="no-access" class="section">
      <div class="card center">
        <h3>You don't have access to this module</h3>
        <p class="muted">Pick an appropriate role to view content.</p>
      </div>
    </div>

  </div>
</div>

<!-- Modals -->
<div class="modal" id="modalEvent">
  <div class="panel">
    <h3 id="evModalTitle">Add Event</h3>
    <input id="evName" placeholder="Event name" />
    <div style="display:flex;gap:8px;margin-top:8px">
      <input id="evDate" type="date" />
      <input id="evTime" type="time" />
    </div>
    <textarea id="evDesc" rows="3" style="width:100%;margin-top:8px" placeholder="Description"></textarea>
    <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
      <select id="evStatus">
        <option value="Planning">Planning</option>
        <option value="Ongoing">Ongoing</option>
        <option value="Completed">Completed</option>
      </select>
      <select id="evCategory"></select>
      <div class="spacer"></div>
    </div>
    <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
      <button class="small" onclick="closeEventModal()">Cancel</button>
      <button class="small green" onclick="saveEvent()">Save</button>
    </div>
  </div>
</div>

<div class="modal" id="modalCreateAdmin">
  <div class="panel">
    <h3>Create Admin</h3>
    <input id="newAdminUser" placeholder="username" />
    <input id="newAdminEmail" placeholder="email" />
    <input id="newAdminPass" type="password" placeholder="password (optional)" />
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button class="small" onclick="closeCreateAdmin()">Cancel</button>
      <button class="small purple" onclick="createAdminSubmit()">Create</button>
    </div>
  </div>
</div>

<script>
/* ---------- STORAGE KEYS ---------- */
const KEY_USERS = 'app_users';
const KEY_EVENTS = 'events';
const KEY_GUESTS = 'guests';
const KEY_CATEGORIES = 'categories';
const KEY_BACKUPS = 'backups';
const KEY_CURRENT = 'current_user';

/* ---------- STORAGE HELPERS ---------- */
function getUsers(){ 
  return JSON.parse(localStorage.getItem(KEY_USERS) || '[]'); 
}
function setUsers(u){ 
  localStorage.setItem(KEY_USERS, JSON.stringify(u)); 
}

function getEvents(){
   return JSON.parse(localStorage.getItem(KEY_EVENTS) || '[]'); 
  }
function setEvents(v){ 
  localStorage.setItem(KEY_EVENTS, JSON.stringify(v)); 
}

function getGuests(){ 
  return JSON.parse(localStorage.getItem(KEY_GUESTS) || '[]'); 
}
function setGuests(v){ 
  localStorage.setItem(KEY_GUESTS, JSON.stringify(v)); 
}

function getCategories(){ 
  return JSON.parse(localStorage.getItem(KEY_CATEGORIES) || '[]'); 
}
function setCategories(v){ 
  localStorage.setItem(KEY_CATEGORIES, JSON.stringify(v)); 
}

function getBackups(){ 
  return JSON.parse(localStorage.getItem(KEY_BACKUPS) || '[]'); 
}
function setBackups(v){ 
  localStorage.setItem(KEY_BACKUPS, JSON.stringify(v)); 
}

function getCurrent(){ 
  return JSON.parse(localStorage.getItem(KEY_CURRENT) || 'null'); 
}
function setCurrent(u){
   localStorage.setItem(KEY_CURRENT, JSON.stringify(u)); 
  }


/* ---------- UI helpers ---------- */
const authArea = document.getElementById('auth-area');
const sidebar = document.getElementById('sidebar');
const pageTitle = document.getElementById('pageTitle');
const roleLabel = document.getElementById('roleLabel');

function showLoginForm(){
  document.getElementById('login-form').style.display='block';
}

/* ---------- SIMPLE LOGIN (NO CREDENTIALS) ---------- */
function loginNoCredential(){
  const username = (document.getElementById('loginUser').value || '').trim();
  const role = (document.getElementById('loginRole').value || 'User');
  if(!username){ alert('Please enter a name'); return; }

  // if user exists, use that; otherwise create new user with selected role
  let users = getUsers();
  let user = users.find(u => u.username.toLowerCase() === username.toLowerCase());
  if(!user){
    user = { username, email:'', password:'', role };
    users.push(user);
    setUsers(users);
  } else {
    // update role if changed
    user.role = role;
    setUsers(users);
  }

  setCurrent(user);
  afterLogin();
}

/* quick reset localStorage for testing */
function clearLocal(){
  if(!confirm('Clear all stored app data?')) return;
  localStorage.clear();
  location.reload();
}

/* Logout */
function logout(){
  localStorage.removeItem(KEY_CURRENT);
  setCurrent(null);
  window.location.reload();
}

/* ---------- AFTER LOGIN ---------- */
function afterLogin(){
  const user = getCurrent();
  if(!user) return;
  // show sidebar / hide auth
  authArea.style.display = 'none';
  sidebar.style.display = 'block';
  document.getElementById('left-pane').style.paddingBottom = '20px';
  document.getElementById('welcomeText').innerHTML = `Hi <strong>${user.username}</strong><div style="font-size:0.85rem;color:rgba(255,255,255,0.9)">${user.role}</div>`;
  roleLabel.innerText = user.role + (user.email ? ' â€¢ ' + user.email : '');

  // show/hide nav items
  document.querySelectorAll('.nav-admin').forEach(el => el.style.display = user.role === 'Admin' ? 'inline-block' : 'none');
  document.querySelectorAll('.nav-user').forEach(el => el.style.display = user.role === 'User' ? 'inline-block' : 'none');

  // default view per role
  if(user.role === 'Admin'){
    showAdminSection('dashboard');
    pageTitle.innerText = 'Admin Panel';
  } else {
    showUserSection('events');
    pageTitle.innerText = 'Event Planner';
  }

  // refresh data
  refreshCounts();
  populateEventSelect();
  populateAgendaEventSelect();
  renderAll();
}

/* ---------- SECTION NAV ---------- */
function hideAllSections(){ document.querySelectorAll('.section').forEach(s=>s.classList.remove('active')); }

function showAdminSection(name){
  const user = getCurrent();
  if(!user){ alert('Not logged in'); return; }
  if(user.role !== 'Admin'){ alert('Access denied'); return; }
  hideAllSections();
  if(name === 'dashboard') document.getElementById('admin-dashboard').classList.add('active');
  if(name === 'users') document.getElementById('admin-users').classList.add('active');
  if(name === 'categories') document.getElementById('admin-categories').classList.add('active');
  if(name === 'backups') document.getElementById('admin-backups').classList.add('active');
  pageTitle.innerText = 'Admin Panel';
  refreshCounts();
}

function showUserSection(name){
  const user = getCurrent();
  if(!user){ alert('Not logged in'); return; }
  hideAllSections();
  if(name === 'events') document.getElementById('user-events').classList.add('active');
  if(name === 'guests') document.getElementById('user-guests').classList.add('active');
  if(name === 'agenda') document.getElementById('user-agenda').classList.add('active');
  pageTitle.innerText = 'Event Planner';
}

/* ---------- ADMIN: Users ---------- */
function renderAdminUsers() {
  const users = getUsers().filter(u => {
    const search = document.getElementById("filterUsers").value.toLowerCase();
    const role = document.getElementById("filterRole").value;
    return (!role || u.role === role) &&
           (!search || u.username.toLowerCase().includes(search) || u.email.toLowerCase().includes(search));
  });

  const tbody = document.querySelector("#usersTable tbody");
  tbody.innerHTML = "";

  users.forEach((u, i) => {
    tbody.innerHTML += `
      <tr>
        <td data-label="Username">${u.username}</td>
        <td data-label="Email">${u.email}</td>
        <td data-label="Role">${u.role}</td>
        <td data-label="Actions">
          <button class="small green" onclick="editUser(${i})">Edit</button>
          <button class="small danger" onclick="deleteUser(${i})">Delete</button>
        </td>
      </tr>
    `;
  });
}

//change
function deleteUser(index){
  const users = getUsers();
  if(!users[index]) return;
  if(!confirm('Delete user ' + users[index].username + '?')) return;

  users.splice(index, 1);
  setUsers(users);
  renderAdminUsers();
  refreshCounts();
}


function impersonateUser(index){
  const u = getUsers()[index];
  if(!u) return;
  setCurrent(u);
  afterLogin();
  alert('Now impersonating '+u.username);
}

/* ---------- ADMIN: edit existing user ---------- */
function editUser(index) {
  const users = getUsers();
  const user = users[index];
  if (!user) return;

  const newUsername = prompt("Edit username:", user.username);
  const newEmail = prompt("Edit email:", user.email);
  const newRole = prompt("Edit role (Admin/User):", user.role);

  if (!newUsername || !newEmail || !newRole) {
    alert("All fields are required!");
    return;
  }

  users[index] = {
    ...user,
    username: newUsername.trim(),
    email: newEmail.trim(),
    role: newRole.trim()
  };

  setUsers(users);
  alert("User updated successfully!");
  renderAdminUsers();
  refreshCounts();
}

/* ---------- ADMIN: create admin modal ---------- */
function openCreateAdmin(){ 
  document.getElementById('modalCreateAdmin').classList.add('show'); 
}
function closeCreateAdmin(){ 
  document.getElementById('modalCreateAdmin').classList.remove('show');
 }
function createAdminSubmit(){
  const username = document.getElementById('newAdminUser').value.trim();
  const email = document.getElementById('newAdminEmail').value.trim();
  const password = document.getElementById('newAdminPass').value || '';
  if(!username){ alert('fill fields'); return; }
  const users = getUsers();
  if(users.some(u=>u.username.toLowerCase()===username.toLowerCase())){ alert('username exists'); return; }
  users.push({ username, email, password, role:'Admin' });
  setUsers(users);
  alert('Admin created');
  document.getElementById('newAdminUser').value=''; document.getElementById('newAdminEmail').value=''; document.getElementById('newAdminPass').value='';
  closeCreateAdmin();
  renderAdminUsers();
  refreshCounts();
}

/* ---------- CATEGORIES ---------- */
function addCategory(){
  const name = document.getElementById('newCategory').value.trim();
  if(!name){ alert('Enter category'); return; }
  const cats = getCategories();
  if(cats.includes(name)){ alert('Category exists'); return; }
  cats.push(name);
  setCategories(cats);
  document.getElementById('newCategory').value='';
  renderCategories();
  populateEventCategory();
  refreshCounts();
}

function renderCategories() {
  const categories = getCategories();
  const tbody = document.querySelector("#categoryTable tbody");
  tbody.innerHTML = "";

  categories.forEach((cat, i) => {
    tbody.innerHTML += `
      <tr>
        <td data-label="Category">${cat}</td>
        <td data-label="Actions">
          <button class="small green" onclick="editCategory(${i})">Edit</button>
          <button class="small danger" onclick="deleteCategory(${i})">Delete</button>
        </td>
      </tr>
    `;
  });
}

function deleteCategory(i){
  if(!confirm('Remove category?')) return;
  const cats = getCategories();
  cats.splice(i,1);
  setCategories(cats);
  renderCategories();
  populateEventCategory();
  refreshCounts();
}

function populateEventCategory(){
  const sel = document.getElementById('evCategory');
  if(!sel) return;
  sel.innerHTML = '<option value="">No category</option>';
  getCategories().forEach(c=> sel.innerHTML += `<option value="${c}">${c}</option>`);
}

/* ---------- EVENTS ---------- */
let editingEventIndex = null;
function openEventModal(idx=null){
  editingEventIndex = idx;
  document.getElementById('modalEvent').classList.add('show');
  if(idx!==null){
    const ev = getEvents()[idx];
    document.getElementById('evModalTitle').innerText = 'Edit Event';
    document.getElementById('evName').value = ev.name;
    document.getElementById('evDate').value = ev.date;
    document.getElementById('evTime').value = ev.time;
    document.getElementById('evDesc').value = ev.desc;
    document.getElementById('evStatus').value = ev.status;
    document.getElementById('evCategory').value = ev.category || '';
  } else {
    document.getElementById('evModalTitle').innerText = 'Add Event';
    document.getElementById('evName').value=''; document.getElementById('evDate').value=''; document.getElementById('evTime').value=''; document.getElementById('evDesc').value=''; document.getElementById('evStatus').value='Planning'; document.getElementById('evCategory').value='';
  }
}
function closeEventModal(){ document.getElementById('modalEvent').classList.remove('show'); editingEventIndex = null; }

function saveEvent(){
  const name = document.getElementById('evName').value.trim();
  const date = document.getElementById('evDate').value;
  const time = document.getElementById('evTime').value;
  const desc = document.getElementById('evDesc').value.trim();
  const status = document.getElementById('evStatus').value;
  const category = document.getElementById('evCategory').value || '';
  if(!name || !date || !time){ alert('Name, date and time required'); return; }
  const evs = getEvents();
  if(editingEventIndex === null){
    evs.push({ name, date, time, desc, status, category, agenda:[] });
  } else {
    evs[editingEventIndex] = { ...evs[editingEventIndex], name, date, time, desc, status, category };
  }
  setEvents(evs);
  closeEventModal();
  renderEvents();
  populateEventSelect();
  populateAgendaEventSelect();
  refreshCounts();
}

/* Render events for user */
function renderEvents(){
  const container = document.getElementById('eventsList');
  if(!container) return;
  container.innerHTML = '';
  const q = (document.getElementById('searchEvent')?.value || '').toLowerCase();
  const statusFilter = (document.getElementById('filterEventStatus')?.value || '');
  getEvents().forEach((ev,i)=>{
    if(q && !([ev.name, ev.desc, ev.category].join(' ').toLowerCase().includes(q))) return;
    if(statusFilter && ev.status !== statusFilter) return;
    const div = document.createElement('div');
    div.className = 'card';
    const statusClass = ev.status==='Planning' ? 'st-planning' : ev.status==='Ongoing' ? 'st-ongoing' : 'st-completed';
    div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h3 style="margin:0">${ev.name}</h3>
          <div class="muted">${ev.date} ${ev.time} â€¢ ${ev.category || 'General'}</div>
        </div>
        <div style="text-align:right">
          <div class="status ${statusClass}">${ev.status}</div>
          <div style="margin-top:8px">
            <button class="small" onclick="openAgendaEditor(${i})">Agenda</button>
            <button class="small blue" onclick="openEventModal(${i})">Edit</button>
            <button class="small danger" onclick="deleteEvent(${i})">Delete</button>
          </div>
        </div>
      </div>
      <div style="margin-top:8px;color:#444">${ev.desc || ''}</div>
      <div id="agenda-preview-${i}" style="margin-top:8px"></div>`;
    container.appendChild(div);
    // show agenda preview if any
    if(ev.agenda && ev.agenda.length){
      const list = ev.agenda.map(a=>`<div style="font-size:0.85rem;margin-top:6px"><b>${a.start}-${a.end}</b> ${a.desc}</div>`).join('');
      document.getElementById(`agenda-preview-${i}`).innerHTML = list;
    }
  });
}

/* Event delete */
function deleteEvent(i){
  if(!confirm('Delete event?')) return;
  const evs = getEvents();
  evs.splice(i,1);
  setEvents(evs);
  renderEvents();
  populateEventSelect();
  populateAgendaEventSelect();
  refreshCounts();
}

/* ---------- Agenda editor (prompt-based for brevity) ---------- */
function openAgendaEditor(i){
  const evs = getEvents();
  const ev = evs[i];
  if(!ev) return;
  const addMore = confirm(`Open agenda for "${ev.name}". OK to add an item, Cancel to view items.`);
  if(addMore){
    const start = prompt('Start time (HH:MM)', '09:00');
    if(!start) return;
    const end = prompt('End time (HH:MM)', '10:00');
    if(!end) return;
    const desc = prompt('Description', 'Topic');
    if(!desc) return;
    ev.agenda = ev.agenda || [];
    ev.agenda.push({ start, end, desc });
    evs[i] = ev;
    setEvents(evs);
    renderEvents();
    alert('Agenda added');
    populateAgendaEventSelect();
  } else {
    if(!ev.agenda || !ev.agenda.length) alert('No agenda items');
    else alert(ev.agenda.map(a=>`${a.start}-${a.end}: ${a.desc}`).join('\n'));
  }
}

/* ---------- GUESTS ---------- */
let editingGuestIndex = null;
function populateEventSelect(){
  const sel = document.getElementById('guestEventSelect');
  if(!sel) return;
  sel.innerHTML = '<option value="">Select event</option>';
  getEvents().forEach((e,i)=> sel.innerHTML += `<option value="${e.name}">${e.name} (${e.date})</option>`);
}

function populateAgendaEventSelect(){
  const sel = document.getElementById('agendaEventSelect');
  if(!sel) return;
  sel.innerHTML = '<option value="">Select event</option>';
  getEvents().forEach((e,i)=> sel.innerHTML += `<option value="${i}">${e.name} (${e.date})</option>`);
}

function addOrUpdateGuest(){
  const name = document.getElementById('guestName').value.trim();
  const email = document.getElementById('guestEmail').value.trim();
  const eventName = document.getElementById('guestEventSelect').value;
  if(!name||!email||!eventName){ alert('Fill all'); return; }
  const guests = getGuests();
  if(editingGuestIndex === null){
    guests.push({ name, email, event: eventName, rsvp: 'Pending' });
  } else {
    guests[editingGuestIndex] = { ...guests[editingGuestIndex], name, email, event: eventName };
    editingGuestIndex = null;
  }
  setGuests(guests);
  document.getElementById('guestName').value=''; document.getElementById('guestEmail').value=''; document.getElementById('guestEventSelect').value='';
  renderGuests();
  refreshCounts();
}

function renderGuests() {
  const guests = getGuests();
  const tbody = document.getElementById("guestTable");
  tbody.innerHTML = "";
  guests.forEach((g, i) => {
    tbody.innerHTML += `
      <tr>
        <td data-label="Name">${g.name}</td>
        <td data-label="Email">${g.email}</td>
        <td data-label="Event">${g.event}</td>
        <td data-label="RSVP">${g.rsvp || ""}</td>
        <td data-label="Actions">
          <button class="small green" onclick="editGuest(${i})">Edit</button>
          <button class="small danger" onclick="deleteGuest(${i})">Delete</button>
        </td>
      </tr>
    `;
  });
}


function editGuest(i){
  const g = getGuests()[i];
  if(!g) return;
  document.getElementById('guestName').value = g.name;
  document.getElementById('guestEmail').value = g.email;
  document.getElementById('guestEventSelect').value = g.event;
  editingGuestIndex = i;
}

function removeGuest(i){
  if(!confirm('Remove guest?')) return;
  const gs = getGuests(); gs.splice(i,1); setGuests(gs); renderGuests(); refreshCounts();
}

function updateRSVP(i, val){
  const gs = getGuests(); if(!gs[i]) return;
  gs[i].rsvp = val; setGuests(gs); renderGuests();
}

function sendInvitations(){
  const gs = getGuests();
  if(!gs.length){ alert('No guests'); return; }
  gs.forEach(g=> console.log(`INVITE -> ${g.email} (simulated)`));
  alert('Simulated invitations sent (check console log)');
}

/* ---------- BACKUPS ---------- */
function createBackup(){
  const backups = getBackups();
  const data = {
    time: new Date().toLocaleString(),
    users: getUsers(),
    events: getEvents(),
    guests: getGuests(),
    categories: getCategories()
  };
  backups.push(data);
  setBackups(backups);
  renderBackups();
  refreshCounts();
  alert('Backup created');
}

function renderBackups(){
  const ul = document.getElementById('backupList');
  if(!ul) return;
  ul.innerHTML = '';
  getBackups().forEach((b,i)=>{
    const li = document.createElement('li');
    li.innerHTML = `${b.time} â€¢ <button class="small" onclick="downloadBackup(${i})">Download</button> <button class="small" onclick="restoreBackup(${i})">Restore</button>`;
    ul.appendChild(li);
  });
}

function downloadBackup(i){
  const b = getBackups()[i];
  const blob = new Blob([JSON.stringify(b, null, 2)], { type:'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `backup-${i}.json`; a.click(); URL.revokeObjectURL(url);
}

function restoreBackup(i){
  if(!confirm('Restore this backup? This will overwrite current data.')) return;
  const b = getBackups()[i];
  if(!b) return;
  setUsers(b.users||[]);
  setEvents(b.events||[]);
  setGuests(b.guests||[]);
  setCategories(b.categories||[]);
  alert('Restored backup');
  renderAll();
}

function restoreLastBackup(){
  const backups = getBackups();
  if(!backups.length){ alert('No backups'); return; }
  restoreBackup(backups.length - 1);
}

function showAllBackups(){ renderBackups(); alert('Backups displayed below'); }

/* ---------- EXPORT / CLEAR ---------- */
function downloadData(){
  const data = {
    users: getUsers(), events: getEvents(), guests: getGuests(), categories: getCategories(), backups: getBackups()
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type:'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'app-data.json'; a.click(); URL.revokeObjectURL(url);
}

function clearAllData(){
  if(!confirm('Clear all app data (except default admin)?')) return;
  localStorage.removeItem(KEY_EVENTS);
  localStorage.removeItem(KEY_GUESTS);
  localStorage.removeItem(KEY_CATEGORIES);
  localStorage.removeItem(KEY_BACKUPS);
  // preserve admin account if exists
  const users = getUsers().filter(u => u.username === 'admin');
  setUsers(users);
  alert('Cleared (default admin preserved). Reloading...');
  renderAll();
}

/* ---------- REFRESH / UTIL ---------- */
function refreshCounts(){
  document.getElementById('adminUserCount').innerText = getUsers().length;
  document.getElementById('adminCategoryCount').innerText = getCategories().length;
  document.getElementById('adminEventCount').innerText = getEvents().length;
  document.getElementById('adminBackupCount').innerText = getBackups().length;
}

function renderAll(){
  renderAdminUsers();
  renderCategories();
  renderBackups();
  renderEvents();
  renderGuests();
  populateEventSelect();
  populateAgendaEventSelect();
  refreshCounts();
}

/* ---------- AGENDA VIEW ---------- */
function renderAgendaForEvent(){
  const sel = document.getElementById('agendaEventSelect');
  const idx = sel ? sel.value : '';
  const container = document.getElementById('agendaList');
  container.innerHTML = '';
  if(idx === '') { container.innerHTML = '<div class="muted">Select an event to view agenda</div>'; return; }
  const ev = getEvents()[Number(idx)];
  if(!ev){ container.innerHTML = '<div class="muted">No event found</div>'; return; }
  if(!ev.agenda || !ev.agenda.length){
    container.innerHTML = '<div class="muted">No agenda items yet</div>'; return;
  }
  ev.agenda.forEach(a=>{
    const d = document.createElement('div');
    d.className = 'card';
    d.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><b>${a.start} - ${a.end}</b></div></div><div style="margin-top:6px">${a.desc}</div>`;
    container.appendChild(d);
  });
}

/* ---------- INIT ---------- */
window.addEventListener('load', ()=>{
  // Always start on login page
  setCurrent(null); // clear current login session on load

  authArea.style.display = 'block';
  sidebar.style.display = 'none';
  document.getElementById('pageTitle').innerHTML = '<div class="login-title">Event Planning Management</div>';

  populateEventCategory();
  populateEventSelect();
  populateAgendaEventSelect();
  renderAll();
});

</script>
</body>
</html>